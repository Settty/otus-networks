#  Тема: Внедрение динамической маршрутизации через безопасные VPN каналы с технологией DMVPN over IPSec

###  Цели проекта:

#### Организовать соединение удаленных офисов с помощью site-to-site VPN (DMVPN)

#### Настроить протокол динамической маршрутизации BGP внутри DVMPN

#### Обеспечить защиту передаваемых данных между удаленными офисами с помощью протоколов IPSec


- [Конфигурационные файлы;](config/)

![](Shema.png)

## 1. Настроите GRE между офисами Москва и С.-Петербург.

 1. На роутере R15 создать интерфейс Tunnel 0 и выполнить настройки для создания GRE туннеля с Питером R18

        interface Tunnel0
        ip address 172.16.0.1 255.255.255.252 - адрес подсети для туннеля
        ip mtu 1400
        ip tcp adjust-mss 1360
        tunnel source 100.100.20.15 - PI адрес AS1001 Москва
        tunnel destination 200.200.30.18 - PI адрес AS2042 Питер

 2. На роутере R18 создать интерфейс Tunnel 0 и выполнить настройки для создания GRE туннеля с Москвой R15

        interface Tunnel0
        ip address 172.16.0.2 255.255.255.252 - адрес подсети для туннеля
        ip mtu 1400
        ip tcp adjust-mss 1360
        keepalive 10 3 - команда для отслеживания работоспособности туннеля. Применение данной команды будет объяснено далее
        tunnel source 200.200.30.18 - PI адрес AS2042 Питер
        tunnel destination 100.100.20.15 - PI адрес AS1001 Москва
        
  3. На роутерах Москвы R15 и Питера R18 прописать статические маршруты до сетей офиса
  
         R15 ip route 192.168.40.0 255.255.255.0 Tunnel0 - сеть 192.168.40.0 сеть Питера
         R15 ip route 192.168.50.0 255.255.255.0 Tunnel0 - сеть 192.168.40.0 сеть Питера
         
         R18 ip route 192.168.20.0 255.255.255.0 Tunnel0 - сеть 192.168.20.0 сеть Москвы
         R18 ip route 192.168.30.0 255.255.255.0 Tunnel0 - сеть 192.168.40.0 сеть Москвы
         
  Пропингуем с ПК Питера имеющего адрес 192.168.40.2 адрес ПК Москвы 192.168.20.129
  
  ![](pingVPC8.png)
  
  Как видно из скриншота пинг удачно проходит и маршрут идет по туннелю 172.16.0.1 (цифра 4 в trace)
  
  Но если роутер R15 Москва по каким-либо причинам будет не доступен, то VPN канал "развалится" и офисные сети перестанут быть доступны между собой.
  Для этого создадим дополнительный туннель между R14 Москва и так же R18 Питер
  
  4. На роутере R14 создать интерфейс Tunnel 0 и выполнить настройки для создания GRE туннеля с Питером R18
  
         interface Tunnel0
         ip address 172.16.0.5 255.255.255.252 адрес подсети для туннеля
         ip mtu 1400
         ip tcp adjust-mss 1360
         tunnel source 100.100.20.14 - PI адрес AS1001 Москва
         tunnel destination 200.200.30.18 - PI адрес AS2042 Питер
  
  5. На роутере R18 создать интерфейс Tunnel 1 (это второй туннель на этом роутере) и выполнить настройки для создания GRE туннеля с Москвой R14
         
         interface Tunnel1
         ip address 172.16.0.6 255.255.255.252
         ip mtu 1400
         ip tcp adjust-mss 1360
         tunnel source 200.200.30.18 - PI адрес AS2042 Питер
         tunnel destination 100.100.20.14 - PI адрес AS1001 Москва
         
   6. На роутерах Москвы R14 и Питера R18 прописать статические маршруты до сетей офиса.

          R14 ip route 192.168.40.0 255.255.255.0 Tunnel0 - сеть 192.168.40.0 сеть Питера
          R14 ip route 192.168.50.0 255.255.255.0 Tunnel0 - сеть 192.168.40.0 сеть Питера
          
      По скольку на R18 Питер уже прописаны статические маршруты до сетей офиса Москвы через Tunnel0, то необходимо прописать маршруты до этих сетей через Tunnel1 c более худшей метрикой (10)  
      
          R18 ip route 192.168.20.0 255.255.255.0 Tunnel1 10 - сеть 192.168.20.0 сеть Москвы 
          R18 ip route 192.168.30.0 255.255.255.0 Tunnel1 10 - сеть 192.168.30.0 сеть Москвы 
          
   Теперь на роутере R18 по два маршрута в каждую сеть, но в таблицу маршрутизации попадет маршрут с более лучшей метрикой. 
   
   ![](R18.png)

  Команда "keepalive 10" прописанная ранее на R18 в конфиге Tunnel0 необходима для того, что бы каждые 10 секунд посылать ICMP запрос на R15. Т.е тем самым    проверяется работоспособность туннеля между R18 и R15. И если R15 становится недоступным, то на R18 появляется диагностическое сообщение
%LINEPROTO-5-UPDOWN: Line protocol on Interface Tunnel0, changed state to DOWN

   ![](R18_2.png)
   
 На скриншоте выше в таблице маршрутизации R18 трафик до сетей офиса Москвы шел через Tunnel0. Далее R15 перестал быть доступным и появилось сообщение LINEPROTO-5-UPDOWN: Line protocol on Interface Tunnel0, changed state to down. Таблица маршрутизации до офиса Москвы изменилась и трафик пошел на Tunnel1. Затем R15 стал доступен и появилось диагностическое сообщение %LINEPROTO-5-UPDOWN: Line protocol on Interface Tunnel0, changed state to UP. Трафик снова пошел через Tunnel0
 
 Так же видно что ПК из офиса Питера после падения канала между R15 и R18 стал идти через 172.16.0.5, а после восстановления канала снова стал идти через 172.16.0.1
 
 ![](pingVPC8_2.png)



## 2. Настроите DMVPN между Москва и Чокурдах, Лабытнанги

 1. На R15 Москва создадим Tunnel1 (Tunnel0 используется для GRE c Питером). Подсесть для DMVPN будет 172.16.10.0 /24

        interface Tunnel1
        ip address 172.16.10.1 255.255.255.0 адрес подсети для туннеля DMVPN
        ip mtu 1400
        ip nhrp map multicast dynamic
        ip nhrp network-id 1 - задает идентификатор процесса NHRP
        ip nhrp redirect - данная команда включает режим 3 фазы DMVPN на HUB
        ip tcp adjust-mss 1360
        tunnel source Loopback1 - это PI адрес R15. Можно было указать IP как в варианте с GRE (100.100.20.15)
        tunnel mode gre multipoint
        ip ospf network point-to-multipoint - режим работы OSPF в NBMA сети
        ip ospf 1 area 0
        
  2. На R27 Лабытнаги создадим Tunnel0 

         interface Tunnel0
         ip address 172.16.10.2 255.255.255.0
         ip mtu 1400
         ip nhrp map 172.16.10.1 100.100.20.15 - указывает соответсвие между адресом туннеля и белым адресом Hub
         ip nhrp map multicast 100.100.20.15 
         ip nhrp network-id 1
         ip nhrp nhs 172.16.10.1
         ip nhrp shortcut - данная команда включает режим 3 фазы DMVPN на SPOKE
         ip tcp adjust-mss 1360
         tunnel source Ethernet0/0 - интерфейс источника. Можно было прописать IP выдаваемый от Триады (120.120.120.2)
         tunnel mode gre multipoint - задает режим работы туннеля
         ip ospf network point-to-multipoint
         ip ospf 1 area 0
         
   3. На R28 Чокурдах создадим Tunnel0 аналогично R27

          interface Tunnel0
          ip address 172.16.10.3 255.255.255.0
          ip mtu 1400
          ip nhrp map 172.16.10.1 100.100.20.15 - указывает соответсвие между адресом туннеля и белым адресом Hub
          ip nhrp map multicast 100.100.20.15 
          ip nhrp network-id 1
          ip nhrp nhs 172.16.10.1
          ip nhrp shortcut - данная команда включает режим 3 фазы DMVPN на SPOKE
          ip tcp adjust-mss 1360
          tunnel source Ethernet0/1 - интерфейс источника. Можно было прописать IP выдаваемый от Триады (130.130.130.2)
          tunnel mode gre multipoint - задает режим работы туннеля
          ip ospf network point-to-multipoint
          ip ospf 1 area 0
          
    
   Проверяем на R15 установку туннелей между R27 и R28 
   
   ![](R15_DM.png)
   
   Проверяем на R27 установку таблицу NHRP и PING до R28 (172.16.10.3) 
   
   ![](R27.png)

   Но если по каким-либо причинам Hub роутер R15 будет недоступен, то R27 через некоторое время потеряет доступность с R28. 
   Для повышения отказоустойчивости настроим еще один Hub роутер R14. 
   Схема сети DMVPN будет Dual Hub Single Cloud.
   
   4. На R14 Hub2 Москва создадим Tunnel1 (Tunnel0 используется для GRE c Питером). Подсесть для DMVPN будет 172.16.10.0 /24.

          interface Tunnel1
          ip address 172.16.10.20 255.255.255.0 адрес подсети для туннеля DMVPN (из той же подсети, что и R15 у которого 172.16.10.1/24)
          ip mtu 1400
          ip nhrp map multicast dynamic
          ip nhrp network-id 1 - задает идентификатор процесса NHRP
          ip nhrp redirect - данная команда включает режим 3 фазы DMVPN на HUB
          ip tcp adjust-mss 1360
          tunnel source Loopback1 - это PI адрес R14. Можно было указать IP как в варианте с GRE (100.100.20.15)
          tunnel mode gre multipoint
          ip ospf network point-to-multipoint - режим работы OSPF в NBMA сети 
          ip ospf 1 area 0
          
   5. На роутерах R27 и R28 SPOKE ввести дополнительные команды для второго NHS R14 172.16.10.20 

          ip nhrp map 172.16.10.20 100.100.20.14 - указывает соответсвие между адресом туннеля и белым адресом Hub 2 R14
          ip nhrp map multicast 100.100.20.14
          ip nhrp nhs 172.16.10.20 - второй NHS сервер R14
        
   
   Таблица соседей OSPF роутера R15
   
   ![](R15_OSPF.png) 
   
   Таблица соседей OSPF роутера R14
   
   ![](R14_OSPF.png)
   
   Так же на скриншоте ниже видно, что к сетям офиса пришедшим по OSPF будет осуществляться балансировка, что в ситуации с VPN тунелями не очень правильно.
   
   ![](R27_OSPF.png)
   
   Для избежания балансировки по OSPF необходимо на SPOKE R27 и R28 применить следующую команду
   
        router ospf 1
        neighbor 172.16.10.20 cost 2000 - данной командой завышается стоимость маршрутов полученных от R14. R15 становится основным.
        
   ![](R27_OSPF2.png)  
   
   
   Пропингуем сеть офиса Москва из сети R28 Чокурдах. 
   Трассировка показывает, что маршрут идет через туннель 172.16.10.1
   
   ![](ping1.png)
   
   При отключении роутера R15 некоторое время маршрут снова восстанавливается, но трассировка уже идет через 172.16.10.20
   
   ![](ping2.png)
